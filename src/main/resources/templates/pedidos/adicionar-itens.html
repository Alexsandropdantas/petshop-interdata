<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Editar Pedido</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link th:href="@{/css/estilo.css}" rel="stylesheet">

    <style>
        /* Estilos adicionais específicos para esta página, se necessário */
        .total-section {
            text-align: right;
            margin-top: 20px;
            font-size: 1.1em;
        }

        .total-section strong {
            display: inline-block;
            min-width: 150px;
            /* Alinhamento */
        }

        .table th,
        .table td {
            vertical-align: middle;
            /* Alinha verticalmente o conteúdo da tabela */
        }

        #clienteId {
            /* Para dar espaço abaixo do select de cliente */
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <div th:replace="~{fragmentos/menu-lateral :: sidebar}"></div>

    <div class="centralizado">
        <div class="container mt-4">

            <h2 class="text-center mb-4">Pedido #<span th:text="${pedido.numeroPedido}">ID</span> - Adicionar/Editar
                Itens</h2>

            <div th:if="${mensagemSucesso}" class="alert alert-success alert-dismissible fade show" role="alert">
                <span th:text="${mensagemSucesso}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${mensagemErro}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${mensagemErro}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${mensagemInfo}" class="alert alert-info alert-dismissible fade show" role="alert">
                <span th:text="${mensagemInfo}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    Adicionar Item ao Pedido
                </div>
                <div class="card-body">
                    <form th:action="@{/pedidos/adicionar-item}" method="post" th:object="${itemPedido}"
                        id="formAdicionarItem">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="produtoId" class="form-label">Produto/Serviço <span
                                        class="text-danger">*</span></label>
                                <select id="produtoId" class="form-select" th:field="*{produto}" required>
                                    <option value="">-- Selecione --</option>
                                    <option th:each="prod : ${produtos}" th:value="${prod.id}" th:text="${prod.nome}"
                                        th:attr="data-preco=${prod.precoVenda}"> </option>
                                </select>
                                <div th:if="${#fields.hasErrors('produto')}" th:errors="*{produto}"
                                    class="text-danger small"></div>
                            </div>

                            <div class="col-md-6">
                                <label for="clienteId" class="form-label">Cliente <span
                                        class="text-danger">*</span></label>
                                <select id="clienteId" class="form-select" th:field="*{cliente}" required>
                                    <option value="">-- Selecione --</option>
                                    <option th:each="cli : ${clientes}" th:value="${cli.id}" th:text="${cli.nome}">
                                    </option>
                                </select>
                                <div th:if="${#fields.hasErrors('cliente')}" th:errors="*{cliente}"
                                    class="text-danger small"></div>
                            </div>

                            <div class="col-md-4">
                                <label for="animalId" class="form-label">Animal (opcional)</label>
                                <select id="animalId" class="form-select" th:field="*{animal}">
                                    <option value="">-- Selecione (se aplicável) --</option>
                                    <option th:each="ani : ${animais}" th:value="${ani.id}"
                                        th:text="${ani.nome} + ' (' + ${ani.raca} + ')'"
                                        th:attr="data-cliente=${ani.cliente?.id}"></option>
                                </select>
                                <div th:if="${#fields.hasErrors('animal')}" th:errors="*{animal}"
                                    class="text-danger small"></div>
                            </div>

                            <div class="col-md-4">
                                <label for="vendedorId" class="form-label">Vendedor <span
                                        class="text-danger">*</span></label>
                                <select id="vendedorId" class="form-select" th:field="*{vendedor}" required>
                                    <option value="">-- Selecione --</option>
                                    <option th:each="vend : ${vendedores}" th:value="${vend.id}" th:text="${vend.nome}">
                                    </option>
                                </select>
                                <div th:if="${#fields.hasErrors('vendedor')}" th:errors="*{vendedor}"
                                    class="text-danger small"></div>
                            </div>

                            <div class="col-md-2">
                                <label for="quantidade" class="form-label">Quantidade <span
                                        class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="quantidade" name="quantidade" value="1"
                                    min="1" required>
                            </div>

                            <div class="col-md-2">
                                <label for="precoUnitario" class="form-label">Preço Unit.</label>
                                <input type="number" class="form-control" id="precoUnitario" name="precoUnitario"
                                    step="0.01" min="0.00" placeholder="Automático">
                            </div>

                            <div class="col-12 text-end">
                                <button type="submit" class="btn btn-success">Adicionar Item</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    Itens do Pedido
                </div>
                <div class="card-body">
                    <div th:if="${#lists.isEmpty(pedido.itens)}" class="alert alert-light text-center" role="alert">
                        Nenhum item adicionado a este pedido ainda.
                    </div>

                    <div class="table-responsive" th:if="${not #lists.isEmpty(pedido.itens)}">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Produto/Serviço</th>
                                    <th>Cliente</th>
                                    <th>Animal</th>
                                    <th>Vendedor</th>
                                    <th class="text-center">Qtd</th>
                                    <th class="text-end">Preço Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                    <th class="text-center">Ação</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item, iterStat : ${pedido.itens}">
                                    <td th:text="${iterStat.count}">1</td>
                                    <td th:text="${item.produto?.nome}">Nome Produto</td>
                                    <td th:text="${item.cliente?.nome}">Nome Cliente</td>
                                    <td th:text="${item.animal?.nome}">Nome Animal</td>
                                    <td th:text="${item.vendedor?.nome}">Nome Vendedor</td>
                                    <td class="text-center" th:text="${item.quantidade}">1</td>
                                    <td class="text-end" th:text="${#numbers.formatCurrency(item.precoUnitario)}">R$
                                        0,00</td>
                                    <td class="text-end" th:text="${#numbers.formatCurrency(item.getSubtotal())}">R$
                                        0,00</td>
                                    <td class="text-center">
                                        <a th:href="@{/pedidos/remover-item/{itemId}(itemId=${item.id})}"
                                            class="btn btn-sm btn-outline-danger" title="Remover Item"
                                            onclick="return confirm('Tem certeza que deseja remover este item?');">
                                            <i class="bi bi-trash"></i> Remover
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-muted total-section" th:if="${not #lists.isEmpty(pedido.itens)}">
                    <div>
                        <strong>Subtotal:</strong>
                        <span th:text="${#numbers.formatCurrency(pedido.calcularSubtotal())}">R$ 0,00</span>
                    </div>
                    <form th:action="@{/pedidos/finalizar}" method="post" class="d-inline-block me-2 align-middle">
                        <div class="input-group input-group-sm my-2" style="max-width: 250px; display: inline-flex;">
                            <span class="input-group-text"><strong>Desconto (R$):</strong></span>
                            <input type="number" name="desconto" class="form-control form-control-sm"
                                th:value="${pedido.desconto ?: 0.00}" step="0.01" min="0.00">
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm align-baseline">
                            <i class="bi bi-check-circle"></i> Finalizar Pedido
                        </button>
                    </form>
                    <hr style="max-width: 300px; margin-left: auto;">
                    <div>
                        <strong>Total:</strong>
                        <span th:text="${#numbers.formatCurrency(pedido.calcularTotal())}"
                            style="font-weight: bold; font-size: 1.2em;">R$ 0,00</span>
                    </div>
                </div>
            </div>

            <div class="mt-4 text-center">
                <a th:href="@{/pedidos}" class="btn btn-secondary">
                    <i class="bi bi-list-ul"></i> Ver Lista de Pedidos
                </a>
                <a th:href="@{/pedidos/cancelar}" class="btn btn-danger"
                    onclick="return confirm('Tem certeza que deseja cancelar este pedido? Todos os itens serão perdidos e o pedido será excluído.');">
                    <i class="bi bi-x-circle"></i> Cancelar Pedido Atual
                </a>
            </div>

        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const clienteSelect = document.getElementById('clienteId');
            const animalSelect = document.getElementById('animalId');
            const produtoSelect = document.getElementById('produtoId');
            const precoInput = document.getElementById('precoUnitario');

            // Guarda todas as opções de animais
            const animalOptions = Array.from(animalSelect.options).slice(1); // Ignora o "-- Selecione"

            // Função para filtrar animais
            function filtrarAnimais() {
                const clienteIdSelecionado = clienteSelect.value;
                // Limpa opções atuais (mantendo a primeira "-- Selecione")
                animalSelect.innerHTML = '<option value="">-- Selecione (se aplicável) --</option>';

                if (clienteIdSelecionado) {
                    animalOptions.forEach(option => {
                        if (option.getAttribute('data-cliente') === clienteIdSelecionado) {
                            animalSelect.add(option.cloneNode(true));
                        }
                    });
                } else {
                    // Se nenhum cliente selecionado, talvez mostrar todos ou nenhum?
                    // Atualmente, mostra apenas o placeholder. Se quiser mostrar todos:
                    // animalOptions.forEach(option => animalSelect.add(option.cloneNode(true)));
                }
                animalSelect.disabled = !clienteIdSelecionado; // Desabilita se não houver cliente
            }

            // Função para preencher preço (exemplo)
            function preencherPreco() {
                const selectedOption = produtoSelect.options[produtoSelect.selectedIndex];
                const preco = selectedOption.getAttribute('data-preco');
                if (preco && !precoInput.value) { // Só preenche se houver preço e o campo estiver vazio
                    precoInput.value = parseFloat(preco).toFixed(2);
                }
            }

            // Adiciona listeners
            if (clienteSelect) {
                clienteSelect.addEventListener('change', filtrarAnimais);
                // Chama na carga inicial caso um cliente já venha selecionado (edição)
                filtrarAnimais();
            }
            if (produtoSelect && precoInput) {
                produtoSelect.addEventListener('change', preencherPreco);
                // Chama na carga para caso de edição
                // preencherPreco(); // Pode causar problemas se o preço foi alterado manualmente
            }

        });
    </script>
</body>

</html>